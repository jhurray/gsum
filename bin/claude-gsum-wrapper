#!/bin/bash
# Wrapper for gsum commands called from Claude
# This ensures proper execution and debug logging

MODE="$1"
shift
ARGS="$*"

# Debug logging
echo "üîç Running /gsum-$MODE command from Claude..."
echo "Working directory: $(pwd)"
echo "Arguments: $ARGS"

# Show version info
if [ -d "/Users/jhurray/src/gsum/.git" ]; then
    cd /Users/jhurray/src/gsum 2>/dev/null
    LAST_COMMIT=$(git log -1 --format="%h - %s (%cr)" 2>/dev/null || echo "unknown")
    LAST_UPDATE=$(git log -1 --format="%ci" 2>/dev/null || echo "unknown")
    echo "üì¶ gsum version: $LAST_COMMIT"
    echo "üìÖ Last updated: $LAST_UPDATE"
    cd - >/dev/null 2>&1
else
    echo "üì¶ gsum version: installed from source (no git info)"
fi

# Check if smart-gsum exists
if ! command -v smart-gsum >/dev/null 2>&1; then
    echo "‚ùå ERROR: smart-gsum command not found in PATH"
    echo "PATH is: $PATH"
    echo "Looking for smart-gsum in common locations..."
    find ~/bin /usr/local/bin ~/.local/bin -name "smart-gsum" -type f 2>/dev/null || echo "Not found in common locations"
    exit 1
fi

echo "‚úÖ Found smart-gsum at: $(command -v smart-gsum)"

# Execute the appropriate command
case "$MODE" in
    "save")
        echo "üìù Running smart-gsum --save..."
        gsum-debug-wrapper gsum-save $ARGS
        if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Debug wrapper failed, trying direct execution..."
            smart-gsum --save $ARGS
        fi
        ;;
    "plan")
        echo "üìã Running smart-gsum --plan..."
        gsum-debug-wrapper gsum-plan "$ARGS"
        if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Debug wrapper failed, trying direct execution..."
            smart-gsum --plan "$ARGS"
        fi
        ;;
    "ephemeral"|"")
        echo "üí≠ Running smart-gsum (ephemeral)..."
        gsum-debug-wrapper gsum $ARGS
        if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Debug wrapper failed, trying direct execution..."
            smart-gsum $ARGS
        fi
        ;;
    *)
        echo "‚ùå ERROR: Unknown gsum mode: $MODE"
        echo "Valid modes: save, plan, ephemeral"
        exit 1
        ;;
esac